import * as tslib_1 from "tslib";
import { Injectable, Inject } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import CONSTANTS from '../constants';
import { WINDOW_TOKEN } from './window.service';
import { ReplaySubject } from 'rxjs';
import { CheckoutOptions } from '../models';
import * as i0 from "@angular/core";
import * as i1 from "./window.service";
import * as i2 from "@angular/common";
var CheckoutService = /** @class */ (function () {
    function CheckoutService(window, document) {
        var _this = this;
        this.window = window;
        this.document = document;
        this.openInPopup = true;
        this.isScriptLoaded = false;
        this.isScriptLoading = false;
        this.checkoutJsContainerId = CONSTANTS.IDS.CHECKOUT_ELEMENT + (new Date()).getTime();
        this.checkoutJsInstanceSource$ = new ReplaySubject(1);
        this.checkoutJsInstance$ = this.checkoutJsInstanceSource$.asObservable();
        this.setupCheckoutJs = function () {
            var checkoutJsInstance = _this.getCheckoutJsObj();
            if (checkoutJsInstance && checkoutJsInstance.onLoad) {
                checkoutJsInstance.onLoad(function () {
                    _this.isScriptLoaded = true;
                    _this.isScriptLoading = false;
                    _this.initializeCheckout();
                });
            }
        };
        this.initializeCheckout = function () {
            var checkoutJsInstance = _this.getCheckoutJsObj();
            if (checkoutJsInstance && checkoutJsInstance.init && checkoutJsInstance.invoke) {
                checkoutJsInstance
                    .init(tslib_1.__assign({}, _this.config, { root: _this.openInPopup ? '' : "#" + _this.checkoutJsContainerId }))
                    .then(function (_) {
                    _this.checkoutJsInstanceSource$.next(checkoutJsInstance);
                })
                    .catch(function (error) {
                    console.error(CONSTANTS.ERRORS.INIT, error);
                });
            }
            else {
                console.error(CONSTANTS.ERRORS.INVALID_CHECKOUT_JS_INSTANCE);
            }
        };
    }
    CheckoutService.prototype.init = function (config, options) {
        options = CheckoutOptions.from(options);
        var merchantId = config && config.merchant && config.merchant.mid;
        if (merchantId) {
            var prevMerchantId = this.config && this.config.merchant && this.config.merchant.mid;
            this.config = config;
            this.openInPopup = options.openInPopup;
            if (options.checkoutJsInstance) {
                this.receivedCheckoutJsInstance = options.checkoutJsInstance;
                this.checkoutJsInstanceSource$.next(options.checkoutJsInstance);
            }
            if ((options.checkoutJsInstance || this.isScriptLoaded) && merchantId === prevMerchantId) {
                this.initializeCheckout();
                this.checkoutJsInstance$;
            }
            else if (!this.isScriptLoading || (prevMerchantId && merchantId !== prevMerchantId)) {
                this.loadCheckoutScript(merchantId, options.env);
            }
        }
        else {
            console.error(CONSTANTS.ERRORS.MERCHANT_ID_NOT_FOUND);
        }
    };
    CheckoutService.prototype.loadCheckoutScript = function (merchantId, env) {
        var _this = this;
        this.isScriptLoaded = false;
        this.isScriptLoading = true;
        var scriptElement = this.document.createElement('script');
        scriptElement.async = true;
        scriptElement.src = CONSTANTS.HOSTS[env] + CONSTANTS.LINKS.CHECKOUT_JS_URL.concat(merchantId);
        scriptElement.type = 'application/javascript';
        scriptElement.onload = this.setupCheckoutJs;
        scriptElement.onError = function () {
            _this.isScriptLoading = false;
        };
        this.document.body.appendChild(scriptElement);
    };
    CheckoutService.prototype.getCheckoutJsObj = function () {
        var window = this.window;
        if (this.receivedCheckoutJsInstance) {
            return this.receivedCheckoutJsInstance;
        }
        if (window && window.Paytm && window.Paytm.CheckoutJS) {
            return window.Paytm.CheckoutJS;
        }
        console.warn(CONSTANTS.ERRORS.CHECKOUT_NOT_AVAILABLE);
        return null;
    };
    CheckoutService.prototype.ngOnDestroy = function () {
        this.checkoutJsInstanceSource$.complete();
    };
    CheckoutService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    CheckoutService.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Inject, args: [WINDOW_TOKEN,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
    ]; };
    CheckoutService.ngInjectableDef = i0.defineInjectable({ factory: function CheckoutService_Factory() { return new CheckoutService(i0.inject(i1.WINDOW_TOKEN), i0.inject(i2.DOCUMENT)); }, token: CheckoutService, providedIn: "root" });
    return CheckoutService;
}());
export { CheckoutService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tvdXQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL3BheXRtLWJsaW5rLWNoZWNrb3V0LWFuZ3VsYXIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvY2hlY2tvdXQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDOUQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sU0FBUyxNQUFNLGNBQWMsQ0FBQztBQUNyQyxPQUFPLEVBQUUsWUFBWSxFQUFVLE1BQU0sa0JBQWtCLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNyQyxPQUFPLEVBQXFCLGVBQWUsRUFBeUIsTUFBTSxXQUFXLENBQUM7Ozs7QUFFdEY7SUFjRSx5QkFDeUMsTUFBYyxFQUNsQixRQUFhO1FBRmxELGlCQUdDO1FBRndDLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDbEIsYUFBUSxHQUFSLFFBQVEsQ0FBSztRQVgxQyxnQkFBVyxHQUFHLElBQUksQ0FBQztRQUNuQixtQkFBYyxHQUFHLEtBQUssQ0FBQztRQUN2QixvQkFBZSxHQUFHLEtBQUssQ0FBQztRQUV2QiwwQkFBcUIsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLGdCQUFnQixHQUFHLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRXhFLDhCQUF5QixHQUFHLElBQUksYUFBYSxDQUFvQixDQUFDLENBQUMsQ0FBQztRQUM1RSx3QkFBbUIsR0FBRyxJQUFJLENBQUMseUJBQXlCLENBQUMsWUFBWSxFQUFFLENBQUM7UUFpRHJFLG9CQUFlLEdBQUc7WUFDeEIsSUFBTSxrQkFBa0IsR0FBRyxLQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUVuRCxJQUFJLGtCQUFrQixJQUFJLGtCQUFrQixDQUFDLE1BQU0sRUFBRTtnQkFDbkQsa0JBQWtCLENBQUMsTUFBTSxDQUFDO29CQUN4QixLQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztvQkFDM0IsS0FBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7b0JBQzdCLEtBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO2dCQUM1QixDQUFDLENBQUMsQ0FBQzthQUNKO1FBQ0gsQ0FBQyxDQUFBO1FBRU8sdUJBQWtCLEdBQUc7WUFDM0IsSUFBTSxrQkFBa0IsR0FBRyxLQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUVuRCxJQUFJLGtCQUFrQixJQUFJLGtCQUFrQixDQUFDLElBQUksSUFBSSxrQkFBa0IsQ0FBQyxNQUFNLEVBQUU7Z0JBQzlFLGtCQUFrQjtxQkFDZixJQUFJLHNCQUNBLEtBQUksQ0FBQyxNQUFNLElBQ2QsSUFBSSxFQUFFLEtBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBSSxLQUFJLENBQUMscUJBQXVCLElBQzlEO3FCQUNELElBQUksQ0FBQyxVQUFBLENBQUM7b0JBQ0wsS0FBSSxDQUFDLHlCQUF5QixDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO2dCQUMxRCxDQUFDLENBQUM7cUJBQ0QsS0FBSyxDQUFDLFVBQUMsS0FBSztvQkFDWCxPQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUM5QyxDQUFDLENBQUMsQ0FBQzthQUNOO2lCQUFNO2dCQUNMLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO2FBQzlEO1FBQ0gsQ0FBQyxDQUFBO0lBMUVELENBQUM7SUFFRCw4QkFBSSxHQUFKLFVBQUssTUFBVyxFQUFFLE9BQTBCO1FBQzFDLE9BQU8sR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXhDLElBQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxNQUFNLENBQUMsUUFBUSxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDO1FBRXBFLElBQUksVUFBVSxFQUFFO1lBQ2QsSUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUM7WUFDdkYsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7WUFDckIsSUFBSSxDQUFDLFdBQVcsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDO1lBRXZDLElBQUksT0FBTyxDQUFDLGtCQUFrQixFQUFFO2dCQUM5QixJQUFJLENBQUMsMEJBQTBCLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDO2dCQUM3RCxJQUFJLENBQUMseUJBQXlCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO2FBQ2pFO1lBRUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksVUFBVSxLQUFLLGNBQWMsRUFBRTtnQkFDeEYsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7Z0JBQzFCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQTthQUN6QjtpQkFDSSxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsSUFBSSxDQUFDLGNBQWMsSUFBSSxVQUFVLEtBQUssY0FBYyxDQUFDLEVBQUU7Z0JBQ25GLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ2xEO1NBRUY7YUFBTTtZQUNMLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1NBQ3ZEO0lBQ0gsQ0FBQztJQUVPLDRDQUFrQixHQUExQixVQUEyQixVQUFrQixFQUFFLEdBQVE7UUFBdkQsaUJBWUM7UUFYQyxJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQztRQUM1QixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQztRQUM1QixJQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM1RCxhQUFhLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUMzQixhQUFhLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzlGLGFBQWEsQ0FBQyxJQUFJLEdBQUcsd0JBQXdCLENBQUM7UUFDOUMsYUFBYSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDO1FBQzVDLGFBQWEsQ0FBQyxPQUFPLEdBQUc7WUFDdEIsS0FBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7UUFDL0IsQ0FBQyxDQUFDO1FBQ0YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFrQ08sMENBQWdCLEdBQXhCO1FBQ0UsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUUzQixJQUFJLElBQUksQ0FBQywwQkFBMEIsRUFBRTtZQUNuQyxPQUFPLElBQUksQ0FBQywwQkFBMEIsQ0FBQztTQUN4QztRQUVELElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxLQUFLLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUU7WUFDckQsT0FBTyxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQztTQUNoQztRQUVELE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBQ3RELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELHFDQUFXLEdBQVg7UUFDRSxJQUFJLENBQUMseUJBQXlCLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDNUMsQ0FBQzs7Z0JBOUdGLFVBQVUsU0FBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7Ozs7Z0RBYUksTUFBTSxTQUFDLFlBQVk7Z0RBQ25CLE1BQU0sU0FBQyxRQUFROzs7MEJBdkJwQjtDQXNIQyxBQS9HRCxJQStHQztTQTVHWSxlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0LCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCBDT05TVEFOVFMgZnJvbSAnLi4vY29uc3RhbnRzJztcbmltcG9ydCB7IFdJTkRPV19UT0tFTiwgV2luZG93IH0gZnJvbSAnLi93aW5kb3cuc2VydmljZSc7XG5pbXBvcnQgeyBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBJQ2hlY2tvdXRJbnN0YW5jZSwgQ2hlY2tvdXRPcHRpb25zLCBFbnYgLCBJQ2hlY2tvdXRPcHRpb25zfSBmcm9tICcuLi9tb2RlbHMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBDaGVja291dFNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwcml2YXRlIGNvbmZpZzogYW55O1xuICBwcml2YXRlIG9wZW5JblBvcHVwID0gdHJ1ZTtcbiAgcHJpdmF0ZSBpc1NjcmlwdExvYWRlZCA9IGZhbHNlO1xuICBwcml2YXRlIGlzU2NyaXB0TG9hZGluZyA9IGZhbHNlO1xuICBwcml2YXRlIHJlY2VpdmVkQ2hlY2tvdXRKc0luc3RhbmNlOiBJQ2hlY2tvdXRJbnN0YW5jZTtcbiAgcmVhZG9ubHkgY2hlY2tvdXRKc0NvbnRhaW5lcklkID0gQ09OU1RBTlRTLklEUy5DSEVDS09VVF9FTEVNRU5UICsgKG5ldyBEYXRlKCkpLmdldFRpbWUoKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGNoZWNrb3V0SnNJbnN0YW5jZVNvdXJjZSQgPSBuZXcgUmVwbGF5U3ViamVjdDxJQ2hlY2tvdXRJbnN0YW5jZT4oMSk7XG4gIHJlYWRvbmx5IGNoZWNrb3V0SnNJbnN0YW5jZSQgPSB0aGlzLmNoZWNrb3V0SnNJbnN0YW5jZVNvdXJjZSQuYXNPYnNlcnZhYmxlKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChXSU5ET1dfVE9LRU4pIHByaXZhdGUgcmVhZG9ubHkgd2luZG93OiBXaW5kb3csXG4gICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSByZWFkb25seSBkb2N1bWVudDogYW55KSB7XG4gIH1cblxuICBpbml0KGNvbmZpZzogYW55LCBvcHRpb25zPzogSUNoZWNrb3V0T3B0aW9ucyk6IHZvaWQge1xuICAgIG9wdGlvbnMgPSBDaGVja291dE9wdGlvbnMuZnJvbShvcHRpb25zKTtcblxuICAgIGNvbnN0IG1lcmNoYW50SWQgPSBjb25maWcgJiYgY29uZmlnLm1lcmNoYW50ICYmIGNvbmZpZy5tZXJjaGFudC5taWQ7XG5cbiAgICBpZiAobWVyY2hhbnRJZCkge1xuICAgICAgY29uc3QgcHJldk1lcmNoYW50SWQgPSB0aGlzLmNvbmZpZyAmJiB0aGlzLmNvbmZpZy5tZXJjaGFudCAmJiB0aGlzLmNvbmZpZy5tZXJjaGFudC5taWQ7XG4gICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICAgIHRoaXMub3BlbkluUG9wdXAgPSBvcHRpb25zLm9wZW5JblBvcHVwO1xuXG4gICAgICBpZiAob3B0aW9ucy5jaGVja291dEpzSW5zdGFuY2UpIHtcbiAgICAgICAgdGhpcy5yZWNlaXZlZENoZWNrb3V0SnNJbnN0YW5jZSA9IG9wdGlvbnMuY2hlY2tvdXRKc0luc3RhbmNlO1xuICAgICAgICB0aGlzLmNoZWNrb3V0SnNJbnN0YW5jZVNvdXJjZSQubmV4dChvcHRpb25zLmNoZWNrb3V0SnNJbnN0YW5jZSk7XG4gICAgICB9XG5cbiAgICAgIGlmICgob3B0aW9ucy5jaGVja291dEpzSW5zdGFuY2UgfHwgdGhpcy5pc1NjcmlwdExvYWRlZCkgJiYgbWVyY2hhbnRJZCA9PT0gcHJldk1lcmNoYW50SWQpIHtcbiAgICAgICAgdGhpcy5pbml0aWFsaXplQ2hlY2tvdXQoKTtcbiAgICAgICAgdGhpcy5jaGVja291dEpzSW5zdGFuY2UkXG4gICAgICB9XG4gICAgICBlbHNlIGlmICghdGhpcy5pc1NjcmlwdExvYWRpbmcgfHwgKHByZXZNZXJjaGFudElkICYmIG1lcmNoYW50SWQgIT09IHByZXZNZXJjaGFudElkKSkge1xuICAgICAgICB0aGlzLmxvYWRDaGVja291dFNjcmlwdChtZXJjaGFudElkLCBvcHRpb25zLmVudik7XG4gICAgICB9XG5cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcihDT05TVEFOVFMuRVJST1JTLk1FUkNIQU5UX0lEX05PVF9GT1VORCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBsb2FkQ2hlY2tvdXRTY3JpcHQobWVyY2hhbnRJZDogc3RyaW5nLCBlbnY6IEVudik6IHZvaWQge1xuICAgIHRoaXMuaXNTY3JpcHRMb2FkZWQgPSBmYWxzZTtcbiAgICB0aGlzLmlzU2NyaXB0TG9hZGluZyA9IHRydWU7XG4gICAgY29uc3Qgc2NyaXB0RWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgc2NyaXB0RWxlbWVudC5hc3luYyA9IHRydWU7XG4gICAgc2NyaXB0RWxlbWVudC5zcmMgPSBDT05TVEFOVFMuSE9TVFNbZW52XSArIENPTlNUQU5UUy5MSU5LUy5DSEVDS09VVF9KU19VUkwuY29uY2F0KG1lcmNoYW50SWQpO1xuICAgIHNjcmlwdEVsZW1lbnQudHlwZSA9ICdhcHBsaWNhdGlvbi9qYXZhc2NyaXB0JztcbiAgICBzY3JpcHRFbGVtZW50Lm9ubG9hZCA9IHRoaXMuc2V0dXBDaGVja291dEpzO1xuICAgIHNjcmlwdEVsZW1lbnQub25FcnJvciA9ICgpID0+IHtcbiAgICAgIHRoaXMuaXNTY3JpcHRMb2FkaW5nID0gZmFsc2U7XG4gICAgfTtcbiAgICB0aGlzLmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0RWxlbWVudCk7XG4gIH1cblxuICBwcml2YXRlIHNldHVwQ2hlY2tvdXRKcyA9ICgpOiB2b2lkID0+IHtcbiAgICBjb25zdCBjaGVja291dEpzSW5zdGFuY2UgPSB0aGlzLmdldENoZWNrb3V0SnNPYmooKTtcblxuICAgIGlmIChjaGVja291dEpzSW5zdGFuY2UgJiYgY2hlY2tvdXRKc0luc3RhbmNlLm9uTG9hZCkge1xuICAgICAgY2hlY2tvdXRKc0luc3RhbmNlLm9uTG9hZCgoKSA9PiB7XG4gICAgICAgIHRoaXMuaXNTY3JpcHRMb2FkZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLmlzU2NyaXB0TG9hZGluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLmluaXRpYWxpemVDaGVja291dCgpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0aWFsaXplQ2hlY2tvdXQgPSAoKTogdm9pZCA9PiB7XG4gICAgY29uc3QgY2hlY2tvdXRKc0luc3RhbmNlID0gdGhpcy5nZXRDaGVja291dEpzT2JqKCk7XG5cbiAgICBpZiAoY2hlY2tvdXRKc0luc3RhbmNlICYmIGNoZWNrb3V0SnNJbnN0YW5jZS5pbml0ICYmIGNoZWNrb3V0SnNJbnN0YW5jZS5pbnZva2UpIHtcbiAgICAgIGNoZWNrb3V0SnNJbnN0YW5jZVxuICAgICAgICAuaW5pdCh7XG4gICAgICAgICAgLi4udGhpcy5jb25maWcsXG4gICAgICAgICAgcm9vdDogdGhpcy5vcGVuSW5Qb3B1cCA/ICcnIDogYCMke3RoaXMuY2hlY2tvdXRKc0NvbnRhaW5lcklkfWBcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oXyA9PiB7XG4gICAgICAgICAgdGhpcy5jaGVja291dEpzSW5zdGFuY2VTb3VyY2UkLm5leHQoY2hlY2tvdXRKc0luc3RhbmNlKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoQ09OU1RBTlRTLkVSUk9SUy5JTklULCBlcnJvcik7XG4gICAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmVycm9yKENPTlNUQU5UUy5FUlJPUlMuSU5WQUxJRF9DSEVDS09VVF9KU19JTlNUQU5DRSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRDaGVja291dEpzT2JqKCk6IElDaGVja291dEluc3RhbmNlIHwgbnVsbCB7XG4gICAgY29uc3Qgd2luZG93ID0gdGhpcy53aW5kb3c7XG5cbiAgICBpZiAodGhpcy5yZWNlaXZlZENoZWNrb3V0SnNJbnN0YW5jZSkge1xuICAgICAgcmV0dXJuIHRoaXMucmVjZWl2ZWRDaGVja291dEpzSW5zdGFuY2U7XG4gICAgfVxuXG4gICAgaWYgKHdpbmRvdyAmJiB3aW5kb3cuUGF5dG0gJiYgd2luZG93LlBheXRtLkNoZWNrb3V0SlMpIHtcbiAgICAgIHJldHVybiB3aW5kb3cuUGF5dG0uQ2hlY2tvdXRKUztcbiAgICB9XG5cbiAgICBjb25zb2xlLndhcm4oQ09OU1RBTlRTLkVSUk9SUy5DSEVDS09VVF9OT1RfQVZBSUxBQkxFKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuY2hlY2tvdXRKc0luc3RhbmNlU291cmNlJC5jb21wbGV0ZSgpO1xuICB9XG59XG4iXX0=