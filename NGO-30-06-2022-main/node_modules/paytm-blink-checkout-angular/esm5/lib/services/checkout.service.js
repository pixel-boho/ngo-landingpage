import * as tslib_1 from "tslib";
import { Injectable, Inject } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import CONSTANTS from '../constants';
import { WINDOW_TOKEN } from './window.service';
import { ReplaySubject } from 'rxjs';
import { CheckoutOptions } from '../models';
import * as i0 from "@angular/core";
import * as i1 from "./window.service";
import * as i2 from "@angular/common";
import * as ɵngcc0 from '@angular/core';
var CheckoutService = /** @class */ (function () {
    function CheckoutService(window, document) {
        var _this = this;
        this.window = window;
        this.document = document;
        this.openInPopup = true;
        this.isScriptLoaded = false;
        this.isScriptLoading = false;
        this.checkoutJsContainerId = CONSTANTS.IDS.CHECKOUT_ELEMENT + (new Date()).getTime();
        this.checkoutJsInstanceSource$ = new ReplaySubject(1);
        this.checkoutJsInstance$ = this.checkoutJsInstanceSource$.asObservable();
        this.setupCheckoutJs = function () {
            var checkoutJsInstance = _this.getCheckoutJsObj();
            if (checkoutJsInstance && checkoutJsInstance.onLoad) {
                checkoutJsInstance.onLoad(function () {
                    _this.isScriptLoaded = true;
                    _this.isScriptLoading = false;
                    _this.initializeCheckout();
                });
            }
        };
        this.initializeCheckout = function () {
            var checkoutJsInstance = _this.getCheckoutJsObj();
            if (checkoutJsInstance && checkoutJsInstance.init && checkoutJsInstance.invoke) {
                checkoutJsInstance
                    .init(tslib_1.__assign({}, _this.config, { root: _this.openInPopup ? '' : "#" + _this.checkoutJsContainerId }))
                    .then(function (_) {
                    _this.checkoutJsInstanceSource$.next(checkoutJsInstance);
                })
                    .catch(function (error) {
                    console.error(CONSTANTS.ERRORS.INIT, error);
                });
            }
            else {
                console.error(CONSTANTS.ERRORS.INVALID_CHECKOUT_JS_INSTANCE);
            }
        };
    }
    CheckoutService.prototype.init = function (config, options) {
        options = CheckoutOptions.from(options);
        var merchantId = config && config.merchant && config.merchant.mid;
        if (merchantId) {
            var prevMerchantId = this.config && this.config.merchant && this.config.merchant.mid;
            this.config = config;
            this.openInPopup = options.openInPopup;
            if (options.checkoutJsInstance) {
                this.receivedCheckoutJsInstance = options.checkoutJsInstance;
                this.checkoutJsInstanceSource$.next(options.checkoutJsInstance);
            }
            if ((options.checkoutJsInstance || this.isScriptLoaded) && merchantId === prevMerchantId) {
                this.initializeCheckout();
                this.checkoutJsInstance$;
            }
            else if (!this.isScriptLoading || (prevMerchantId && merchantId !== prevMerchantId)) {
                this.loadCheckoutScript(merchantId, options.env);
            }
        }
        else {
            console.error(CONSTANTS.ERRORS.MERCHANT_ID_NOT_FOUND);
        }
    };
    CheckoutService.prototype.loadCheckoutScript = function (merchantId, env) {
        var _this = this;
        this.isScriptLoaded = false;
        this.isScriptLoading = true;
        var scriptElement = this.document.createElement('script');
        scriptElement.async = true;
        scriptElement.src = CONSTANTS.HOSTS[env] + CONSTANTS.LINKS.CHECKOUT_JS_URL.concat(merchantId);
        scriptElement.type = 'application/javascript';
        scriptElement.onload = this.setupCheckoutJs;
        scriptElement.onError = function () {
            _this.isScriptLoading = false;
        };
        this.document.body.appendChild(scriptElement);
    };
    CheckoutService.prototype.getCheckoutJsObj = function () {
        var window = this.window;
        if (this.receivedCheckoutJsInstance) {
            return this.receivedCheckoutJsInstance;
        }
        if (window && window.Paytm && window.Paytm.CheckoutJS) {
            return window.Paytm.CheckoutJS;
        }
        console.warn(CONSTANTS.ERRORS.CHECKOUT_NOT_AVAILABLE);
        return null;
    };
    CheckoutService.prototype.ngOnDestroy = function () {
        this.checkoutJsInstanceSource$.complete();
    };
    /** @nocollapse */
    CheckoutService.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Inject, args: [WINDOW_TOKEN,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
    ]; };
    CheckoutService.ngInjectableDef = i0.defineInjectable({ factory: function CheckoutService_Factory() { return new CheckoutService(i0.inject(i1.WINDOW_TOKEN), i0.inject(i2.DOCUMENT)); }, token: CheckoutService, providedIn: "root" });
CheckoutService.ɵfac = function CheckoutService_Factory(t) { return new (t || CheckoutService)(ɵngcc0.ɵɵinject(WINDOW_TOKEN), ɵngcc0.ɵɵinject(DOCUMENT)); };
CheckoutService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: CheckoutService, factory: function (t) { return CheckoutService.ɵfac(t); }, providedIn: 'root' });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(CheckoutService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [WINDOW_TOKEN]
            }] }, { type: undefined, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }]; }, null); })();
    return CheckoutService;
}());
export { CheckoutService };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tvdXQuc2VydmljZS5qcyIsInNvdXJjZXMiOlsibmc6L3BheXRtLWJsaW5rLWNoZWNrb3V0LWFuZ3VsYXIvbGliL3NlcnZpY2VzL2NoZWNrb3V0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQzlELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLFNBQVMsTUFBTSxjQUFjLENBQUM7QUFDckMsT0FBTyxFQUFFLFlBQVksRUFBVSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckMsT0FBTyxFQUFxQixlQUFlLEVBQXlCLE1BQU0sV0FBVyxDQUFDO0FBQ3RGO0FBR0M7QUFDcUM7O0FBSHRDO0FBR2EsSUFXWCx5QkFDeUMsTUFBYyxFQUNsQixRQUFhO0FBQ3BELFFBSEUsaUJBR0M7QUFDSCxRQUgyQyxXQUFNLEdBQU4sTUFBTSxDQUFRO0FBQUMsUUFDbkIsYUFBUSxHQUFSLFFBQVEsQ0FBSztBQUFDLFFBWDNDLGdCQUFXLEdBQUcsSUFBSSxDQUFDO0FBQzdCLFFBQVUsbUJBQWMsR0FBRyxLQUFLLENBQUM7QUFDakMsUUFBVSxvQkFBZSxHQUFHLEtBQUssQ0FBQztBQUNsQyxRQUNXLDBCQUFxQixHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDM0YsUUFDbUIsOEJBQXlCLEdBQUcsSUFBSSxhQUFhLENBQW9CLENBQUMsQ0FBQyxDQUFDO0FBQ3ZGLFFBQVcsd0JBQW1CLEdBQUcsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFlBQVksRUFBRSxDQUFDO0FBQy9FLFFBZ0RVLG9CQUFlLEdBQUc7QUFDNUIsWUFBSSxJQUFNLGtCQUFrQixHQUFHLEtBQUks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SUFBSSxDQUFDLE1BQU0sQ0FBQztBQUMvQixRQUNJLElBQUksSUFBSSxDQUFDLDBCQUEwQixFQUFFO0FBQ3pDLFlBQU0sT0FBTyxJQUFJLENBQUMsMEJBQTBCLENBQUM7QUFDN0MsU0FBSztBQUNMLFFBQ0ksSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLEtBQUssSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRTtBQUMzRCxZQUFNLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUM7QUFDckMsU0FBSztBQUNMLFFBQ0ksT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDMUQsUUFBSSxPQUFPLElBQUksQ0FBQztBQUNoQixJQUFFLENBQUM7QUFFSCxJQUFFLHFDQUFXLEdBQVg7QUFBYyxRQUNaLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUM5QyxJQUFFLENBQUMsQ0EzR007QUFBQzs0QkFIVCxVQUFVLFNBQUMsL0NBR3FCO1NBRi9CLFVBQVUsRUFBRSxNQUFNLGtCQUNuQiw3Q0FHaUIsZ0RBVWIsTUFBTSxTQUFDLFlBQVk7QUFBUyxnREFDNUIsTUFBTSxTQUFDLFFBQVE7QUFBUTtBQUFVOzs7Ozs7Ozs7Ozs7OztrQ0FTeEI7QUFBQywwQkFoQ2Y7QUFBRSxDQXNIRCxBQS9HRCxJQStHQztBQUNELFNBN0dhLGVBQWU7QUFBSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgQ09OU1RBTlRTIGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBXSU5ET1dfVE9LRU4sIFdpbmRvdyB9IGZyb20gJy4vd2luZG93LnNlcnZpY2UnO1xuaW1wb3J0IHsgUmVwbGF5U3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSUNoZWNrb3V0SW5zdGFuY2UsIENoZWNrb3V0T3B0aW9ucywgRW52ICwgSUNoZWNrb3V0T3B0aW9uc30gZnJvbSAnLi4vbW9kZWxzJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQ2hlY2tvdXRTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBjb25maWc6IGFueTtcbiAgcHJpdmF0ZSBvcGVuSW5Qb3B1cCA9IHRydWU7XG4gIHByaXZhdGUgaXNTY3JpcHRMb2FkZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBpc1NjcmlwdExvYWRpbmcgPSBmYWxzZTtcbiAgcHJpdmF0ZSByZWNlaXZlZENoZWNrb3V0SnNJbnN0YW5jZTogSUNoZWNrb3V0SW5zdGFuY2U7XG4gIHJlYWRvbmx5IGNoZWNrb3V0SnNDb250YWluZXJJZCA9IENPTlNUQU5UUy5JRFMuQ0hFQ0tPVVRfRUxFTUVOVCArIChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBjaGVja291dEpzSW5zdGFuY2VTb3VyY2UkID0gbmV3IFJlcGxheVN1YmplY3Q8SUNoZWNrb3V0SW5zdGFuY2U+KDEpO1xuICByZWFkb25seSBjaGVja291dEpzSW5zdGFuY2UkID0gdGhpcy5jaGVja291dEpzSW5zdGFuY2VTb3VyY2UkLmFzT2JzZXJ2YWJsZSgpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoV0lORE9XX1RPS0VOKSBwcml2YXRlIHJlYWRvbmx5IHdpbmRvdzogV2luZG93LFxuICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgcmVhZG9ubHkgZG9jdW1lbnQ6IGFueSkge1xuICB9XG5cbiAgaW5pdChjb25maWc6IGFueSwgb3B0aW9ucz86IElDaGVja291dE9wdGlvbnMpOiB2b2lkIHtcbiAgICBvcHRpb25zID0gQ2hlY2tvdXRPcHRpb25zLmZyb20ob3B0aW9ucyk7XG5cbiAgICBjb25zdCBtZXJjaGFudElkID0gY29uZmlnICYmIGNvbmZpZy5tZXJjaGFudCAmJiBjb25maWcubWVyY2hhbnQubWlkO1xuXG4gICAgaWYgKG1lcmNoYW50SWQpIHtcbiAgICAgIGNvbnN0IHByZXZNZXJjaGFudElkID0gdGhpcy5jb25maWcgJiYgdGhpcy5jb25maWcubWVyY2hhbnQgJiYgdGhpcy5jb25maWcubWVyY2hhbnQubWlkO1xuICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgICB0aGlzLm9wZW5JblBvcHVwID0gb3B0aW9ucy5vcGVuSW5Qb3B1cDtcblxuICAgICAgaWYgKG9wdGlvbnMuY2hlY2tvdXRKc0luc3RhbmNlKSB7XG4gICAgICAgIHRoaXMucmVjZWl2ZWRDaGVja291dEpzSW5zdGFuY2UgPSBvcHRpb25zLmNoZWNrb3V0SnNJbnN0YW5jZTtcbiAgICAgICAgdGhpcy5jaGVja291dEpzSW5zdGFuY2VTb3VyY2UkLm5leHQob3B0aW9ucy5jaGVja291dEpzSW5zdGFuY2UpO1xuICAgICAgfVxuXG4gICAgICBpZiAoKG9wdGlvbnMuY2hlY2tvdXRKc0luc3RhbmNlIHx8IHRoaXMuaXNTY3JpcHRMb2FkZWQpICYmIG1lcmNoYW50SWQgPT09IHByZXZNZXJjaGFudElkKSB7XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZUNoZWNrb3V0KCk7XG4gICAgICAgIHRoaXMuY2hlY2tvdXRKc0luc3RhbmNlJFxuICAgICAgfVxuICAgICAgZWxzZSBpZiAoIXRoaXMuaXNTY3JpcHRMb2FkaW5nIHx8IChwcmV2TWVyY2hhbnRJZCAmJiBtZXJjaGFudElkICE9PSBwcmV2TWVyY2hhbnRJZCkpIHtcbiAgICAgICAgdGhpcy5sb2FkQ2hlY2tvdXRTY3JpcHQobWVyY2hhbnRJZCwgb3B0aW9ucy5lbnYpO1xuICAgICAgfVxuXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoQ09OU1RBTlRTLkVSUk9SUy5NRVJDSEFOVF9JRF9OT1RfRk9VTkQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbG9hZENoZWNrb3V0U2NyaXB0KG1lcmNoYW50SWQ6IHN0cmluZywgZW52OiBFbnYpOiB2b2lkIHtcbiAgICB0aGlzLmlzU2NyaXB0TG9hZGVkID0gZmFsc2U7XG4gICAgdGhpcy5pc1NjcmlwdExvYWRpbmcgPSB0cnVlO1xuICAgIGNvbnN0IHNjcmlwdEVsZW1lbnQgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgIHNjcmlwdEVsZW1lbnQuYXN5bmMgPSB0cnVlO1xuICAgIHNjcmlwdEVsZW1lbnQuc3JjID0gQ09OU1RBTlRTLkhPU1RTW2Vudl0gKyBDT05TVEFOVFMuTElOS1MuQ0hFQ0tPVVRfSlNfVVJMLmNvbmNhdChtZXJjaGFudElkKTtcbiAgICBzY3JpcHRFbGVtZW50LnR5cGUgPSAnYXBwbGljYXRpb24vamF2YXNjcmlwdCc7XG4gICAgc2NyaXB0RWxlbWVudC5vbmxvYWQgPSB0aGlzLnNldHVwQ2hlY2tvdXRKcztcbiAgICBzY3JpcHRFbGVtZW50Lm9uRXJyb3IgPSAoKSA9PiB7XG4gICAgICB0aGlzLmlzU2NyaXB0TG9hZGluZyA9IGZhbHNlO1xuICAgIH07XG4gICAgdGhpcy5kb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdEVsZW1lbnQpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cENoZWNrb3V0SnMgPSAoKTogdm9pZCA9PiB7XG4gICAgY29uc3QgY2hlY2tvdXRKc0luc3RhbmNlID0gdGhpcy5nZXRDaGVja291dEpzT2JqKCk7XG5cbiAgICBpZiAoY2hlY2tvdXRKc0luc3RhbmNlICYmIGNoZWNrb3V0SnNJbnN0YW5jZS5vbkxvYWQpIHtcbiAgICAgIGNoZWNrb3V0SnNJbnN0YW5jZS5vbkxvYWQoKCkgPT4ge1xuICAgICAgICB0aGlzLmlzU2NyaXB0TG9hZGVkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5pc1NjcmlwdExvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5pbml0aWFsaXplQ2hlY2tvdXQoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5pdGlhbGl6ZUNoZWNrb3V0ID0gKCk6IHZvaWQgPT4ge1xuICAgIGNvbnN0IGNoZWNrb3V0SnNJbnN0YW5jZSA9IHRoaXMuZ2V0Q2hlY2tvdXRKc09iaigpO1xuXG4gICAgaWYgKGNoZWNrb3V0SnNJbnN0YW5jZSAmJiBjaGVja291dEpzSW5zdGFuY2UuaW5pdCAmJiBjaGVja291dEpzSW5zdGFuY2UuaW52b2tlKSB7XG4gICAgICBjaGVja291dEpzSW5zdGFuY2VcbiAgICAgICAgLmluaXQoe1xuICAgICAgICAgIC4uLnRoaXMuY29uZmlnLFxuICAgICAgICAgIHJvb3Q6IHRoaXMub3BlbkluUG9wdXAgPyAnJyA6IGAjJHt0aGlzLmNoZWNrb3V0SnNDb250YWluZXJJZH1gXG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKF8gPT4ge1xuICAgICAgICAgIHRoaXMuY2hlY2tvdXRKc0luc3RhbmNlU291cmNlJC5uZXh0KGNoZWNrb3V0SnNJbnN0YW5jZSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKENPTlNUQU5UUy5FUlJPUlMuSU5JVCwgZXJyb3IpO1xuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcihDT05TVEFOVFMuRVJST1JTLklOVkFMSURfQ0hFQ0tPVVRfSlNfSU5TVEFOQ0UpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2hlY2tvdXRKc09iaigpOiBJQ2hlY2tvdXRJbnN0YW5jZSB8IG51bGwge1xuICAgIGNvbnN0IHdpbmRvdyA9IHRoaXMud2luZG93O1xuXG4gICAgaWYgKHRoaXMucmVjZWl2ZWRDaGVja291dEpzSW5zdGFuY2UpIHtcbiAgICAgIHJldHVybiB0aGlzLnJlY2VpdmVkQ2hlY2tvdXRKc0luc3RhbmNlO1xuICAgIH1cblxuICAgIGlmICh3aW5kb3cgJiYgd2luZG93LlBheXRtICYmIHdpbmRvdy5QYXl0bS5DaGVja291dEpTKSB7XG4gICAgICByZXR1cm4gd2luZG93LlBheXRtLkNoZWNrb3V0SlM7XG4gICAgfVxuXG4gICAgY29uc29sZS53YXJuKENPTlNUQU5UUy5FUlJPUlMuQ0hFQ0tPVVRfTk9UX0FWQUlMQUJMRSk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmNoZWNrb3V0SnNJbnN0YW5jZVNvdXJjZSQuY29tcGxldGUoKTtcbiAgfVxufVxuIl19