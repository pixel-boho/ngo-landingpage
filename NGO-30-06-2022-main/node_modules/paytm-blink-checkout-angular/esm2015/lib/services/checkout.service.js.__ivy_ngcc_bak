import { Injectable, Inject } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import CONSTANTS from '../constants';
import { WINDOW_TOKEN } from './window.service';
import { ReplaySubject } from 'rxjs';
import { CheckoutOptions } from '../models';
import * as i0 from "@angular/core";
import * as i1 from "./window.service";
import * as i2 from "@angular/common";
export class CheckoutService {
    constructor(window, document) {
        this.window = window;
        this.document = document;
        this.openInPopup = true;
        this.isScriptLoaded = false;
        this.isScriptLoading = false;
        this.checkoutJsContainerId = CONSTANTS.IDS.CHECKOUT_ELEMENT + (new Date()).getTime();
        this.checkoutJsInstanceSource$ = new ReplaySubject(1);
        this.checkoutJsInstance$ = this.checkoutJsInstanceSource$.asObservable();
        this.setupCheckoutJs = () => {
            const checkoutJsInstance = this.getCheckoutJsObj();
            if (checkoutJsInstance && checkoutJsInstance.onLoad) {
                checkoutJsInstance.onLoad(() => {
                    this.isScriptLoaded = true;
                    this.isScriptLoading = false;
                    this.initializeCheckout();
                });
            }
        };
        this.initializeCheckout = () => {
            const checkoutJsInstance = this.getCheckoutJsObj();
            if (checkoutJsInstance && checkoutJsInstance.init && checkoutJsInstance.invoke) {
                checkoutJsInstance
                    .init(Object.assign({}, this.config, { root: this.openInPopup ? '' : `#${this.checkoutJsContainerId}` }))
                    .then(_ => {
                    this.checkoutJsInstanceSource$.next(checkoutJsInstance);
                })
                    .catch((error) => {
                    console.error(CONSTANTS.ERRORS.INIT, error);
                });
            }
            else {
                console.error(CONSTANTS.ERRORS.INVALID_CHECKOUT_JS_INSTANCE);
            }
        };
    }
    init(config, options) {
        options = CheckoutOptions.from(options);
        const merchantId = config && config.merchant && config.merchant.mid;
        if (merchantId) {
            const prevMerchantId = this.config && this.config.merchant && this.config.merchant.mid;
            this.config = config;
            this.openInPopup = options.openInPopup;
            if (options.checkoutJsInstance) {
                this.receivedCheckoutJsInstance = options.checkoutJsInstance;
                this.checkoutJsInstanceSource$.next(options.checkoutJsInstance);
            }
            if ((options.checkoutJsInstance || this.isScriptLoaded) && merchantId === prevMerchantId) {
                this.initializeCheckout();
                this.checkoutJsInstance$;
            }
            else if (!this.isScriptLoading || (prevMerchantId && merchantId !== prevMerchantId)) {
                this.loadCheckoutScript(merchantId, options.env);
            }
        }
        else {
            console.error(CONSTANTS.ERRORS.MERCHANT_ID_NOT_FOUND);
        }
    }
    loadCheckoutScript(merchantId, env) {
        this.isScriptLoaded = false;
        this.isScriptLoading = true;
        const scriptElement = this.document.createElement('script');
        scriptElement.async = true;
        scriptElement.src = CONSTANTS.HOSTS[env] + CONSTANTS.LINKS.CHECKOUT_JS_URL.concat(merchantId);
        scriptElement.type = 'application/javascript';
        scriptElement.onload = this.setupCheckoutJs;
        scriptElement.onError = () => {
            this.isScriptLoading = false;
        };
        this.document.body.appendChild(scriptElement);
    }
    getCheckoutJsObj() {
        const window = this.window;
        if (this.receivedCheckoutJsInstance) {
            return this.receivedCheckoutJsInstance;
        }
        if (window && window.Paytm && window.Paytm.CheckoutJS) {
            return window.Paytm.CheckoutJS;
        }
        console.warn(CONSTANTS.ERRORS.CHECKOUT_NOT_AVAILABLE);
        return null;
    }
    ngOnDestroy() {
        this.checkoutJsInstanceSource$.complete();
    }
}
CheckoutService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
CheckoutService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [WINDOW_TOKEN,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
CheckoutService.ngInjectableDef = i0.defineInjectable({ factory: function CheckoutService_Factory() { return new CheckoutService(i0.inject(i1.WINDOW_TOKEN), i0.inject(i2.DOCUMENT)); }, token: CheckoutService, providedIn: "root" });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tvdXQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL3BheXRtLWJsaW5rLWNoZWNrb3V0LWFuZ3VsYXIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvY2hlY2tvdXQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBYSxNQUFNLGVBQWUsQ0FBQztBQUM5RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxTQUFTLE1BQU0sY0FBYyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxZQUFZLEVBQVUsTUFBTSxrQkFBa0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JDLE9BQU8sRUFBcUIsZUFBZSxFQUF5QixNQUFNLFdBQVcsQ0FBQzs7OztBQUt0RixNQUFNLE9BQU8sZUFBZTtJQVcxQixZQUN5QyxNQUFjLEVBQ2xCLFFBQWE7UUFEVCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2xCLGFBQVEsR0FBUixRQUFRLENBQUs7UUFYMUMsZ0JBQVcsR0FBRyxJQUFJLENBQUM7UUFDbkIsbUJBQWMsR0FBRyxLQUFLLENBQUM7UUFDdkIsb0JBQWUsR0FBRyxLQUFLLENBQUM7UUFFdkIsMEJBQXFCLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUV4RSw4QkFBeUIsR0FBRyxJQUFJLGFBQWEsQ0FBb0IsQ0FBQyxDQUFDLENBQUM7UUFDNUUsd0JBQW1CLEdBQUcsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFlBQVksRUFBRSxDQUFDO1FBaURyRSxvQkFBZSxHQUFHLEdBQVMsRUFBRTtZQUNuQyxNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBRW5ELElBQUksa0JBQWtCLElBQUksa0JB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Q0FBQztJQUM1QyxDQUFDOzs7WUE5R0YsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7OzRDQWFJLE1BQU0sU0FBQyxZQUFZOzRDQUNuQixNQUFNLFNBQUMsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgQ09OU1RBTlRTIGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBXSU5ET1dfVE9LRU4sIFdpbmRvdyB9IGZyb20gJy4vd2luZG93LnNlcnZpY2UnO1xuaW1wb3J0IHsgUmVwbGF5U3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSUNoZWNrb3V0SW5zdGFuY2UsIENoZWNrb3V0T3B0aW9ucywgRW52ICwgSUNoZWNrb3V0T3B0aW9uc30gZnJvbSAnLi4vbW9kZWxzJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQ2hlY2tvdXRTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBjb25maWc6IGFueTtcbiAgcHJpdmF0ZSBvcGVuSW5Qb3B1cCA9IHRydWU7XG4gIHByaXZhdGUgaXNTY3JpcHRMb2FkZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBpc1NjcmlwdExvYWRpbmcgPSBmYWxzZTtcbiAgcHJpdmF0ZSByZWNlaXZlZENoZWNrb3V0SnNJbnN0YW5jZTogSUNoZWNrb3V0SW5zdGFuY2U7XG4gIHJlYWRvbmx5IGNoZWNrb3V0SnNDb250YWluZXJJZCA9IENPTlNUQU5UUy5JRFMuQ0hFQ0tPVVRfRUxFTUVOVCArIChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBjaGVja291dEpzSW5zdGFuY2VTb3VyY2UkID0gbmV3IFJlcGxheVN1YmplY3Q8SUNoZWNrb3V0SW5zdGFuY2U+KDEpO1xuICByZWFkb25seSBjaGVja291dEpzSW5zdGFuY2UkID0gdGhpcy5jaGVja291dEpzSW5zdGFuY2VTb3VyY2UkLmFzT2JzZXJ2YWJsZSgpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoV0lORE9XX1RPS0VOKSBwcml2YXRlIHJlYWRvbmx5IHdpbmRvdzogV2luZG93LFxuICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgcmVhZG9ubHkgZG9jdW1lbnQ6IGFueSkge1xuICB9XG5cbiAgaW5pdChjb25maWc6IGFueSwgb3B0aW9ucz86IElDaGVja291dE9wdGlvbnMpOiB2b2lkIHtcbiAgICBvcHRpb25zID0gQ2hlY2tvdXRPcHRpb25zLmZyb20ob3B0aW9ucyk7XG5cbiAgICBjb25zdCBtZXJjaGFudElkID0gY29uZmlnICYmIGNvbmZpZy5tZXJjaGFudCAmJiBjb25maWcubWVyY2hhbnQubWlkO1xuXG4gICAgaWYgKG1lcmNoYW50SWQpIHtcbiAgICAgIGNvbnN0IHByZXZNZXJjaGFudElkID0gdGhpcy5jb25maWcgJiYgdGhpcy5jb25maWcubWVyY2hhbnQgJiYgdGhpcy5jb25maWcubWVyY2hhbnQubWlkO1xuICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgICB0aGlzLm9wZW5JblBvcHVwID0gb3B0aW9ucy5vcGVuSW5Qb3B1cDtcblxuICAgICAgaWYgKG9wdGlvbnMuY2hlY2tvdXRKc0luc3RhbmNlKSB7XG4gICAgICAgIHRoaXMucmVjZWl2ZWRDaGVja291dEpzSW5zdGFuY2UgPSBvcHRpb25zLmNoZWNrb3V0SnNJbnN0YW5jZTtcbiAgICAgICAgdGhpcy5jaGVja291dEpzSW5zdGFuY2VTb3VyY2UkLm5leHQob3B0aW9ucy5jaGVja291dEpzSW5zdGFuY2UpO1xuICAgICAgfVxuXG4gICAgICBpZiAoKG9wdGlvbnMuY2hlY2tvdXRKc0luc3RhbmNlIHx8IHRoaXMuaXNTY3JpcHRMb2FkZWQpICYmIG1lcmNoYW50SWQgPT09IHByZXZNZXJjaGFudElkKSB7XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZUNoZWNrb3V0KCk7XG4gICAgICAgIHRoaXMuY2hlY2tvdXRKc0luc3RhbmNlJFxuICAgICAgfVxuICAgICAgZWxzZSBpZiAoIXRoaXMuaXNTY3JpcHRMb2FkaW5nIHx8IChwcmV2TWVyY2hhbnRJZCAmJiBtZXJjaGFudElkICE9PSBwcmV2TWVyY2hhbnRJZCkpIHtcbiAgICAgICAgdGhpcy5sb2FkQ2hlY2tvdXRTY3JpcHQobWVyY2hhbnRJZCwgb3B0aW9ucy5lbnYpO1xuICAgICAgfVxuXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoQ09OU1RBTlRTLkVSUk9SUy5NRVJDSEFOVF9JRF9OT1RfRk9VTkQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbG9hZENoZWNrb3V0U2NyaXB0KG1lcmNoYW50SWQ6IHN0cmluZywgZW52OiBFbnYpOiB2b2lkIHtcbiAgICB0aGlzLmlzU2NyaXB0TG9hZGVkID0gZmFsc2U7XG4gICAgdGhpcy5pc1NjcmlwdExvYWRpbmcgPSB0cnVlO1xuICAgIGNvbnN0IHNjcmlwdEVsZW1lbnQgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgIHNjcmlwdEVsZW1lbnQuYXN5bmMgPSB0cnVlO1xuICAgIHNjcmlwdEVsZW1lbnQuc3JjID0gQ09OU1RBTlRTLkhPU1RTW2Vudl0gKyBDT05TVEFOVFMuTElOS1MuQ0hFQ0tPVVRfSlNfVVJMLmNvbmNhdChtZXJjaGFudElkKTtcbiAgICBzY3JpcHRFbGVtZW50LnR5cGUgPSAnYXBwbGljYXRpb24vamF2YXNjcmlwdCc7XG4gICAgc2NyaXB0RWxlbWVudC5vbmxvYWQgPSB0aGlzLnNldHVwQ2hlY2tvdXRKcztcbiAgICBzY3JpcHRFbGVtZW50Lm9uRXJyb3IgPSAoKSA9PiB7XG4gICAgICB0aGlzLmlzU2NyaXB0TG9hZGluZyA9IGZhbHNlO1xuICAgIH07XG4gICAgdGhpcy5kb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdEVsZW1lbnQpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cENoZWNrb3V0SnMgPSAoKTogdm9pZCA9PiB7XG4gICAgY29uc3QgY2hlY2tvdXRKc0luc3RhbmNlID0gdGhpcy5nZXRDaGVja291dEpzT2JqKCk7XG5cbiAgICBpZiAoY2hlY2tvdXRKc0luc3RhbmNlICYmIGNoZWNrb3V0SnNJbnN0YW5jZS5vbkxvYWQpIHtcbiAgICAgIGNoZWNrb3V0SnNJbnN0YW5jZS5vbkxvYWQoKCkgPT4ge1xuICAgICAgICB0aGlzLmlzU2NyaXB0TG9hZGVkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5pc1NjcmlwdExvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5pbml0aWFsaXplQ2hlY2tvdXQoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5pdGlhbGl6ZUNoZWNrb3V0ID0gKCk6IHZvaWQgPT4ge1xuICAgIGNvbnN0IGNoZWNrb3V0SnNJbnN0YW5jZSA9IHRoaXMuZ2V0Q2hlY2tvdXRKc09iaigpO1xuXG4gICAgaWYgKGNoZWNrb3V0SnNJbnN0YW5jZSAmJiBjaGVja291dEpzSW5zdGFuY2UuaW5pdCAmJiBjaGVja291dEpzSW5zdGFuY2UuaW52b2tlKSB7XG4gICAgICBjaGVja291dEpzSW5zdGFuY2VcbiAgICAgICAgLmluaXQoe1xuICAgICAgICAgIC4uLnRoaXMuY29uZmlnLFxuICAgICAgICAgIHJvb3Q6IHRoaXMub3BlbkluUG9wdXAgPyAnJyA6IGAjJHt0aGlzLmNoZWNrb3V0SnNDb250YWluZXJJZH1gXG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKF8gPT4ge1xuICAgICAgICAgIHRoaXMuY2hlY2tvdXRKc0luc3RhbmNlU291cmNlJC5uZXh0KGNoZWNrb3V0SnNJbnN0YW5jZSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKENPTlNUQU5UUy5FUlJPUlMuSU5JVCwgZXJyb3IpO1xuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcihDT05TVEFOVFMuRVJST1JTLklOVkFMSURfQ0hFQ0tPVVRfSlNfSU5TVEFOQ0UpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2hlY2tvdXRKc09iaigpOiBJQ2hlY2tvdXRJbnN0YW5jZSB8IG51bGwge1xuICAgIGNvbnN0IHdpbmRvdyA9IHRoaXMud2luZG93O1xuXG4gICAgaWYgKHRoaXMucmVjZWl2ZWRDaGVja291dEpzSW5zdGFuY2UpIHtcbiAgICAgIHJldHVybiB0aGlzLnJlY2VpdmVkQ2hlY2tvdXRKc0luc3RhbmNlO1xuICAgIH1cblxuICAgIGlmICh3aW5kb3cgJiYgd2luZG93LlBheXRtICYmIHdpbmRvdy5QYXl0bS5DaGVja291dEpTKSB7XG4gICAgICByZXR1cm4gd2luZG93LlBheXRtLkNoZWNrb3V0SlM7XG4gICAgfVxuXG4gICAgY29uc29sZS53YXJuKENPTlNUQU5UUy5FUlJPUlMuQ0hFQ0tPVVRfTk9UX0FWQUlMQUJMRSk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmNoZWNrb3V0SnNJbnN0YW5jZVNvdXJjZSQuY29tcGxldGUoKTtcbiAgfVxufVxuIl19