import { Injectable, Inject } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import CONSTANTS from '../constants';
import { WINDOW_TOKEN } from './window.service';
import { ReplaySubject } from 'rxjs';
import { CheckoutOptions } from '../models';
import * as i0 from "@angular/core";
import * as i1 from "./window.service";
import * as i2 from "@angular/common";
import * as ɵngcc0 from '@angular/core';
export class CheckoutService {
    constructor(window, document) {
        this.window = window;
        this.document = document;
        this.openInPopup = true;
        this.isScriptLoaded = false;
        this.isScriptLoading = false;
        this.checkoutJsContainerId = CONSTANTS.IDS.CHECKOUT_ELEMENT + (new Date()).getTime();
        this.checkoutJsInstanceSource$ = new ReplaySubject(1);
        this.checkoutJsInstance$ = this.checkoutJsInstanceSource$.asObservable();
        this.setupCheckoutJs = () => {
            const checkoutJsInstance = this.getCheckoutJsObj();
            if (checkoutJsInstance && checkoutJsInstance.onLoad) {
                checkoutJsInstance.onLoad(() => {
                    this.isScriptLoaded = true;
                    this.isScriptLoading = false;
                    this.initializeCheckout();
                });
            }
        };
        this.initializeCheckout = () => {
            const checkoutJsInstance = this.getCheckoutJsObj();
            if (checkoutJsInstance && checkoutJsInstance.init && checkoutJsInstance.invoke) {
                checkoutJsInstance
                    .init(Object.assign({}, this.config, { root: this.openInPopup ? '' : `#${this.checkoutJsContainerId}` }))
                    .then(_ => {
                    this.checkoutJsInstanceSource$.next(checkoutJsInstance);
                })
                    .catch((error) => {
                    console.error(CONSTANTS.ERRORS.INIT, error);
                });
            }
            else {
                console.error(CONSTANTS.ERRORS.INVALID_CHECKOUT_JS_INSTANCE);
            }
        };
    }
    init(config, options) {
        options = CheckoutOptions.from(options);
        const merchantId = config && config.merchant && config.merchant.mid;
        if (merchantId) {
            const prevMerchantId = this.config && this.config.merchant && this.config.merchant.mid;
            this.config = config;
            this.openInPopup = options.openInPopup;
            if (options.checkoutJsInstance) {
                this.receivedCheckoutJsInstance = options.checkoutJsInstance;
                this.checkoutJsInstanceSource$.next(options.checkoutJsInstance);
            }
            if ((options.checkoutJsInstance || this.isScriptLoaded) && merchantId === prevMerchantId) {
                this.initializeCheckout();
                this.checkoutJsInstance$;
            }
            else if (!this.isScriptLoading || (prevMerchantId && merchantId !== prevMerchantId)) {
                this.loadCheckoutScript(merchantId, options.env);
            }
        }
        else {
            console.error(CONSTANTS.ERRORS.MERCHANT_ID_NOT_FOUND);
        }
    }
    loadCheckoutScript(merchantId, env) {
        this.isScriptLoaded = false;
        this.isScriptLoading = true;
        const scriptElement = this.document.createElement('script');
        scriptElement.async = true;
        scriptElement.src = CONSTANTS.HOSTS[env] + CONSTANTS.LINKS.CHECKOUT_JS_URL.concat(merchantId);
        scriptElement.type = 'application/javascript';
        scriptElement.onload = this.setupCheckoutJs;
        scriptElement.onError = () => {
            this.isScriptLoading = false;
        };
        this.document.body.appendChild(scriptElement);
    }
    getCheckoutJsObj() {
        const window = this.window;
        if (this.receivedCheckoutJsInstance) {
            return this.receivedCheckoutJsInstance;
        }
        if (window && window.Paytm && window.Paytm.CheckoutJS) {
            return window.Paytm.CheckoutJS;
        }
        console.warn(CONSTANTS.ERRORS.CHECKOUT_NOT_AVAILABLE);
        return null;
    }
    ngOnDestroy() {
        this.checkoutJsInstanceSource$.complete();
    }
}
CheckoutService.ɵfac = function CheckoutService_Factory(t) { return new (t || CheckoutService)(ɵngcc0.ɵɵinject(WINDOW_TOKEN), ɵngcc0.ɵɵinject(DOCUMENT)); };
CheckoutService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: CheckoutService, factory: CheckoutService.ɵfac, providedIn: 'root' });
/** @nocollapse */
CheckoutService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [WINDOW_TOKEN,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
CheckoutService.ngInjectableDef = i0.defineInjectable({ factory: function CheckoutService_Factory() { return new CheckoutService(i0.inject(i1.WINDOW_TOKEN), i0.inject(i2.DOCUMENT)); }, token: CheckoutService, providedIn: "root" });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(CheckoutService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [WINDOW_TOKEN]
            }] }, { type: undefined, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tvdXQuc2VydmljZS5qcyIsInNvdXJjZXMiOlsibmc6L3BheXRtLWJsaW5rLWNoZWNrb3V0LWFuZ3VsYXIvbGliL3NlcnZpY2VzL2NoZWNrb3V0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDOUQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sU0FBUyxNQUFNLGNBQWMsQ0FBQztBQUNyQyxPQUFPLEVBQUUsWUFBWSxFQUFVLE1BQU0sa0JBQWtCLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNyQyxPQUFPLEVBQXFCLGVBQWUsRUFBeUIsTUFBTSxXQUFXLENBQUM7QUFDdEY7QUFHQztBQUNxQzs7QUFBdEMsTUFBTSxPQUFPLGVBQWU7QUFBRyxJQVc3QixZQUN5QyxNQUFjLEVBQ2xCLFFBQWE7QUFDcEQsUUFGMkMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtBQUFDLFFBQ25CLGFBQVEsR0FBUixRQUFRLENBQUs7QUFBQyxRQVgzQyxnQkFBVyxHQUFHLElBQUksQ0FBQztBQUM3QixRQUFVLG1CQUFjLEdBQUcsS0FBSyxDQUFDO0FBQ2pDLFFBQVUsb0JBQWUsR0FBRyxLQUFLLENBQUM7QUFDbEMsUUFDVywwQkFBcUIsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLGdCQUFnQixHQUFHLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQzNGLFFBQ21CLDhCQUF5QixHQUFHLElBQUksYUFBYSxDQUFvQixDQUFDLENBQUMsQ0FBQztBQUN2RixRQUFXLHdCQUFtQixHQUFHLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQztBQUMvRSxRQWdEVSxvQkFBZSxHQUFHLEdBQVMsRUFBRTtBQUN2QyxZQUFJLE1BQU0sa0JBQWtCLEdB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QUFBSyxRQUMzQixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO0FBQy9CLFFBQ0ksSUFBSSxJQUFJLENBQUMsMEJBQTBCLEVBQUU7QUFDekMsWUFBTSxPQUFPLElBQUksQ0FBQywwQkFBMEIsQ0FBQztBQUM3QyxTQUFLO0FBQ0wsUUFDSSxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsS0FBSyxJQUFJLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFO0FBQzNELFlBQU0sT0FBTyxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQztBQUNyQyxTQUFLO0FBQ0wsUUFDSSxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUMxRCxRQUFJLE9BQU8sSUFBSSxDQUFDO0FBQ2hCLElBQUUsQ0FBQztBQUNILElBQ0UsV0FBVztBQUFLLFFBQ2QsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQzlDLElBQUUsQ0FBQztBQUNIOzJDQS9HQyxVQUFVLFNBQUMsa0JBQ1YsVUFBVSxFQUFFLE1BQU0sY0FDbkI7aUlBQ0k7QUFBQztBQUFtQjtBQUNYLDRDQVdULE1BQU0sU0FBQyxZQUFZO0FBQVMsNENBQzVCLE1BQU0sU0FBQyxRQUFRO0FBQVE7QUFBRzs7Ozs7Ozs7Ozs7O2tDQVM1QjtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0LCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCBDT05TVEFOVFMgZnJvbSAnLi4vY29uc3RhbnRzJztcbmltcG9ydCB7IFdJTkRPV19UT0tFTiwgV2luZG93IH0gZnJvbSAnLi93aW5kb3cuc2VydmljZSc7XG5pbXBvcnQgeyBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBJQ2hlY2tvdXRJbnN0YW5jZSwgQ2hlY2tvdXRPcHRpb25zLCBFbnYgLCBJQ2hlY2tvdXRPcHRpb25zfSBmcm9tICcuLi9tb2RlbHMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBDaGVja291dFNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwcml2YXRlIGNvbmZpZzogYW55O1xuICBwcml2YXRlIG9wZW5JblBvcHVwID0gdHJ1ZTtcbiAgcHJpdmF0ZSBpc1NjcmlwdExvYWRlZCA9IGZhbHNlO1xuICBwcml2YXRlIGlzU2NyaXB0TG9hZGluZyA9IGZhbHNlO1xuICBwcml2YXRlIHJlY2VpdmVkQ2hlY2tvdXRKc0luc3RhbmNlOiBJQ2hlY2tvdXRJbnN0YW5jZTtcbiAgcmVhZG9ubHkgY2hlY2tvdXRKc0NvbnRhaW5lcklkID0gQ09OU1RBTlRTLklEUy5DSEVDS09VVF9FTEVNRU5UICsgKG5ldyBEYXRlKCkpLmdldFRpbWUoKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGNoZWNrb3V0SnNJbnN0YW5jZVNvdXJjZSQgPSBuZXcgUmVwbGF5U3ViamVjdDxJQ2hlY2tvdXRJbnN0YW5jZT4oMSk7XG4gIHJlYWRvbmx5IGNoZWNrb3V0SnNJbnN0YW5jZSQgPSB0aGlzLmNoZWNrb3V0SnNJbnN0YW5jZVNvdXJjZSQuYXNPYnNlcnZhYmxlKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChXSU5ET1dfVE9LRU4pIHByaXZhdGUgcmVhZG9ubHkgd2luZG93OiBXaW5kb3csXG4gICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSByZWFkb25seSBkb2N1bWVudDogYW55KSB7XG4gIH1cblxuICBpbml0KGNvbmZpZzogYW55LCBvcHRpb25zPzogSUNoZWNrb3V0T3B0aW9ucyk6IHZvaWQge1xuICAgIG9wdGlvbnMgPSBDaGVja291dE9wdGlvbnMuZnJvbShvcHRpb25zKTtcblxuICAgIGNvbnN0IG1lcmNoYW50SWQgPSBjb25maWcgJiYgY29uZmlnLm1lcmNoYW50ICYmIGNvbmZpZy5tZXJjaGFudC5taWQ7XG5cbiAgICBpZiAobWVyY2hhbnRJZCkge1xuICAgICAgY29uc3QgcHJldk1lcmNoYW50SWQgPSB0aGlzLmNvbmZpZyAmJiB0aGlzLmNvbmZpZy5tZXJjaGFudCAmJiB0aGlzLmNvbmZpZy5tZXJjaGFudC5taWQ7XG4gICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICAgIHRoaXMub3BlbkluUG9wdXAgPSBvcHRpb25zLm9wZW5JblBvcHVwO1xuXG4gICAgICBpZiAob3B0aW9ucy5jaGVja291dEpzSW5zdGFuY2UpIHtcbiAgICAgICAgdGhpcy5yZWNlaXZlZENoZWNrb3V0SnNJbnN0YW5jZSA9IG9wdGlvbnMuY2hlY2tvdXRKc0luc3RhbmNlO1xuICAgICAgICB0aGlzLmNoZWNrb3V0SnNJbnN0YW5jZVNvdXJjZSQubmV4dChvcHRpb25zLmNoZWNrb3V0SnNJbnN0YW5jZSk7XG4gICAgICB9XG5cbiAgICAgIGlmICgob3B0aW9ucy5jaGVja291dEpzSW5zdGFuY2UgfHwgdGhpcy5pc1NjcmlwdExvYWRlZCkgJiYgbWVyY2hhbnRJZCA9PT0gcHJldk1lcmNoYW50SWQpIHtcbiAgICAgICAgdGhpcy5pbml0aWFsaXplQ2hlY2tvdXQoKTtcbiAgICAgICAgdGhpcy5jaGVja291dEpzSW5zdGFuY2UkXG4gICAgICB9XG4gICAgICBlbHNlIGlmICghdGhpcy5pc1NjcmlwdExvYWRpbmcgfHwgKHByZXZNZXJjaGFudElkICYmIG1lcmNoYW50SWQgIT09IHByZXZNZXJjaGFudElkKSkge1xuICAgICAgICB0aGlzLmxvYWRDaGVja291dFNjcmlwdChtZXJjaGFudElkLCBvcHRpb25zLmVudik7XG4gICAgICB9XG5cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcihDT05TVEFOVFMuRVJST1JTLk1FUkNIQU5UX0lEX05PVF9GT1VORCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBsb2FkQ2hlY2tvdXRTY3JpcHQobWVyY2hhbnRJZDogc3RyaW5nLCBlbnY6IEVudik6IHZvaWQge1xuICAgIHRoaXMuaXNTY3JpcHRMb2FkZWQgPSBmYWxzZTtcbiAgICB0aGlzLmlzU2NyaXB0TG9hZGluZyA9IHRydWU7XG4gICAgY29uc3Qgc2NyaXB0RWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgc2NyaXB0RWxlbWVudC5hc3luYyA9IHRydWU7XG4gICAgc2NyaXB0RWxlbWVudC5zcmMgPSBDT05TVEFOVFMuSE9TVFNbZW52XSArIENPTlNUQU5UUy5MSU5LUy5DSEVDS09VVF9KU19VUkwuY29uY2F0KG1lcmNoYW50SWQpO1xuICAgIHNjcmlwdEVsZW1lbnQudHlwZSA9ICdhcHBsaWNhdGlvbi9qYXZhc2NyaXB0JztcbiAgICBzY3JpcHRFbGVtZW50Lm9ubG9hZCA9IHRoaXMuc2V0dXBDaGVja291dEpzO1xuICAgIHNjcmlwdEVsZW1lbnQub25FcnJvciA9ICgpID0+IHtcbiAgICAgIHRoaXMuaXNTY3JpcHRMb2FkaW5nID0gZmFsc2U7XG4gICAgfTtcbiAgICB0aGlzLmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0RWxlbWVudCk7XG4gIH1cblxuICBwcml2YXRlIHNldHVwQ2hlY2tvdXRKcyA9ICgpOiB2b2lkID0+IHtcbiAgICBjb25zdCBjaGVja291dEpzSW5zdGFuY2UgPSB0aGlzLmdldENoZWNrb3V0SnNPYmooKTtcblxuICAgIGlmIChjaGVja291dEpzSW5zdGFuY2UgJiYgY2hlY2tvdXRKc0luc3RhbmNlLm9uTG9hZCkge1xuICAgICAgY2hlY2tvdXRKc0luc3RhbmNlLm9uTG9hZCgoKSA9PiB7XG4gICAgICAgIHRoaXMuaXNTY3JpcHRMb2FkZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLmlzU2NyaXB0TG9hZGluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLmluaXRpYWxpemVDaGVja291dCgpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0aWFsaXplQ2hlY2tvdXQgPSAoKTogdm9pZCA9PiB7XG4gICAgY29uc3QgY2hlY2tvdXRKc0luc3RhbmNlID0gdGhpcy5nZXRDaGVja291dEpzT2JqKCk7XG5cbiAgICBpZiAoY2hlY2tvdXRKc0luc3RhbmNlICYmIGNoZWNrb3V0SnNJbnN0YW5jZS5pbml0ICYmIGNoZWNrb3V0SnNJbnN0YW5jZS5pbnZva2UpIHtcbiAgICAgIGNoZWNrb3V0SnNJbnN0YW5jZVxuICAgICAgICAuaW5pdCh7XG4gICAgICAgICAgLi4udGhpcy5jb25maWcsXG4gICAgICAgICAgcm9vdDogdGhpcy5vcGVuSW5Qb3B1cCA/ICcnIDogYCMke3RoaXMuY2hlY2tvdXRKc0NvbnRhaW5lcklkfWBcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oXyA9PiB7XG4gICAgICAgICAgdGhpcy5jaGVja291dEpzSW5zdGFuY2VTb3VyY2UkLm5leHQoY2hlY2tvdXRKc0luc3RhbmNlKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoQ09OU1RBTlRTLkVSUk9SUy5JTklULCBlcnJvcik7XG4gICAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmVycm9yKENPTlNUQU5UUy5FUlJPUlMuSU5WQUxJRF9DSEVDS09VVF9KU19JTlNUQU5DRSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRDaGVja291dEpzT2JqKCk6IElDaGVja291dEluc3RhbmNlIHwgbnVsbCB7XG4gICAgY29uc3Qgd2luZG93ID0gdGhpcy53aW5kb3c7XG5cbiAgICBpZiAodGhpcy5yZWNlaXZlZENoZWNrb3V0SnNJbnN0YW5jZSkge1xuICAgICAgcmV0dXJuIHRoaXMucmVjZWl2ZWRDaGVja291dEpzSW5zdGFuY2U7XG4gICAgfVxuXG4gICAgaWYgKHdpbmRvdyAmJiB3aW5kb3cuUGF5dG0gJiYgd2luZG93LlBheXRtLkNoZWNrb3V0SlMpIHtcbiAgICAgIHJldHVybiB3aW5kb3cuUGF5dG0uQ2hlY2tvdXRKUztcbiAgICB9XG5cbiAgICBjb25zb2xlLndhcm4oQ09OU1RBTlRTLkVSUk9SUy5DSEVDS09VVF9OT1RfQVZBSUxBQkxFKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuY2hlY2tvdXRKc0luc3RhbmNlU291cmNlJC5jb21wbGV0ZSgpO1xuICB9XG59XG4iXX0=